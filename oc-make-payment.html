<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../oc-core-utils/oc-core-utils.html">
<!-- Ensure Web Animations polyfill is loaded since neon-animation 2.0 doesn't import it -->
<link rel="import" href="../neon-animation/web-animations.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../oc-core-utils/oc-store.html">
<link rel="import" href="../oc-input-amount/oc-input-amount.html">


<dom-module id="oc-make-payment">
    <template>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <style include="shop-button" is="custom-style">

            :host {
                display: block;
                background: #ffffff;
                color: #000;
            }

            .category-heading {
                border-top: 1px #cecece solid;
                border-bottom: 1px #cecece solid;
                background: #f8f8f8;
                color: #000;
            }
            h3 {
                font-size:1.13em !important;
                margin: 10px 0 !important;
            }

            .pay-button {
                background-color: #e0992f;
                width: 100%;
                height: 50px;
                margin: 10px 0;
            }

            paper-dropdown-menu {
                width:100%;
            }
        </style>
        <oc-accounts-api id="accountsApi"></oc-accounts-api>
        <div class="container-fluid">
            <div class="row">
                <div class="col-xs-12 category-heading">
                    <h3>Pay [[organisation.name]]</h3>
                </div>
            </div>
            <template is="dom-if" if="[[error.isError]]" >
                <div class="row">
                    <div class="col-xs-12">
                        <p class="error"><b>Payment Failed!</b> - [[error.message]]</p>
                    </div>
                </div>
            </template>
            <div class="row">
                <div class="col-xs-12">
                    <oc-input-amount
                            amount="{{_amount}}">
                    </oc-input-amount>

                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <paper-dropdown-menu label="From Account" horizontal-align="left">
                        <paper-listbox id="accountId"
                                       slot="dropdown-content"
                                       selected="{{_selectedAccountId}}" attr-for-selected="value">
                            <template is="dom-repeat" items="[[_accountsList]]" >
                                <paper-item value="[[item.id]]" >[[_capatalize(item.method)]] - [[item.name]]</paper-item>
                            </template>
                        </paper-listbox>
                    </paper-dropdown-menu>
                </div>
            </div>
            <div class="row category-heading">
                <div class="col-xs-12 text-center">
                    <paper-button id="submit" class="pay-button" on-click="_submit" disabled$="{{_loading}}">Pay</paper-button>
                </div>
            </div>
        </div>
    </template>

    <script>
        /**
         * `oc-make-payment`
         * Flash payment element
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class OcMakePayment extends Ordercloud.ReduxMixin(Polymer.Element) {
            static get is() { return 'oc-make-payment';
            }static get properties() {
                return {
                    _userId: {
                        type: Number,
                        statePath:  'identity.user.id',

                    },
                    _organisationId: {
                        type: Number,

                        statePath: 'organisation.id',
                        observer: '_getOrganisationAccounts'
                    },
                    _paymentData: {
                        type : Object,
                        value: {}
                    },
                    _amount: {
                        type: Number,
                    },
                    _selectedAccountId: {
                        type: Number,
                        computed: ''
                    },
                    _toOrganisationId: {
                        type: Number
                    },
                    organisation: Object,
                    _accountList: {
                        type: Array,
                        notify: true
                    },
                    _loading: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },
                    _showPrefix: {
                        type: Boolean,
                        value: false,
                        computed: '_computedShowPrefix(_paymentData.amount)'
                    },//if the payment failed
                    error: {
                        type: Object,
                        value: {"isError":false},
                        notify: true
                    },
                    goBackUrl: {
                        type: String,
                        value: "/"
                    }
                };
            }

            ready() {
                super.ready();
                this._init();
            }

            _computedShowPrefix(amount) {
                return !!amount;
            }_init() {
                this._getOrganisationAccounts();
            }

            _submit() {

                if (!this.$.submit.disabled
                    && this._accountsList.length > 0
                    && this._selectedAccountId) {

                    //disables the button
                    this._loading = true;

                    //build the data for the api call
                    let data = {};
                    data.fromAccountId = this._selectedAccountId;
                    data.amount = this._amount;

                    //passing the type along too know if should display otp page
                    data.toOrganisationId = this.organisation.id;

                    //passing the type along too know if should display otp page
                    for (let i = 0; i < this._accountsList.length; i++) {
                        if (this._accountsList[i].id === this._selectedAccountId)
                            data.method = this._accountsList[i].method
                    }

                    this.dispatchEvent(new CustomEvent('pay-account', {
                            bubbles: true,
                            composed: true,
                            detail: {paymentData: data}
                        })
                    );

                    //reset the inputs
                    this._amount = 0;

                    //disables the button
                    this._loading = false;
                }
            }

            _getOrganisationAccounts(organisationId) {
                if (this._organisationId) {
                    this.$.accountsApi.getOrganisationAccounts(organisationId, 'withdraw')
                        .then(function (accountsRequest) {
                            this._accountsList = accountsRequest.response.results;
                        }.bind(this));
                }
            }

            //Capatalizes a string
            _capatalize(string) {
                return String(string).charAt(0).toUpperCase() + string.slice(1);

            }


        }

        window.customElements.define(OcMakePayment.is, OcMakePayment);
    </script>
</dom-module>
